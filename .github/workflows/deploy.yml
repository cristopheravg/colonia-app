name: Deploy colonia app

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: parajedorteoarango.com
          username: admin
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # ============================================
            # CONFIGURACI√ìN INICIAL
            # ============================================
            set -e  # Detener el script si hay alg√∫n error
            
            # CARGAR NVM
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            nvm use 20
            
            # VERIFICACI√ìN
            echo "========================================="
            echo "‚úÖ Usando Node: $(node -v)"
            echo "‚úÖ Usando NPM: $(npm -v)"
            echo "‚úÖ Usando PM2: $(pm2 -v)"
            echo "========================================="
            
            # ============================================
            # ACTUALIZAR C√ìDIGO
            # ============================================
            echo "üì¶ Actualizando repositorio..."
            cd /var/www/colonia-app
            git fetch --all
            git reset --hard origin/main
            git pull origin main
            
            # ============================================
            # FRONTEND
            # ============================================
            echo "üîß Construyendo frontend..."
            cd frontend
            
            # Instalar TODAS las dependencias (necesario para build)
            echo "üì¶ Instalando dependencias completas..."
            npm ci
            
            echo "üî® Ejecutando build..."
            npm run build
            
            # Verificar que el build se complet√≥
            if [ -d "dist" ]; then
              echo "‚úÖ Build completado! Carpeta dist creada"
            else
              echo "‚ùå ERROR: No se cre√≥ la carpeta dist"
              exit 1
            fi
            
            # ============================================
            # BACKEND
            # ============================================
            echo "üîß Configurando backend..."
            cd ../backend
            
            # Instalar dependencias de producci√≥n
            echo "üì¶ Instalando dependencias del backend..."
            npm ci --only=production
            
            # VERIFICAR QUE EL ARCHIVO DE CONFIGURACI√ìN EXISTE
            if [ ! -f "ecosystem.config.cjs" ]; then
              echo "‚ùå ERROR: ecosystem.config.cjs no encontrado!"
              exit 1
            fi
            
            # DETENER APLICACI√ìN ACTUAL (si existe)
            echo "üõë Deteniendo instancia anterior..."
            pm2 delete colonia-backend 2>/dev/null || true
            
            # INICIAR CON NUEVA CONFIGURACI√ìN
            echo "üöÄ Iniciando backend con ecosystem..."
            pm2 start ecosystem.config.cjs
            
            # ESPERAR 5 SEGUNDOS PARA VERIFICAR QUE NO FALLA
            echo "‚è≥ Verificando que la app se mantenga viva (5s)..."
            sleep 5
            
            # ============================================
            # VERIFICACI√ìN CORREGIDA
            # ============================================
            echo "üìä Verificando estado del backend..."
            
            # Mostrar estado completo
            pm2 status
            
            # Verificar que est√° online
            if pm2 status | grep -q "colonia-backend.*online"; then
              echo "‚úÖ Backend iniciado correctamente"
              
              # Mostrar informaci√≥n detallada (versi√≥n corregida)
              echo "üìã Informaci√≥n detallada:"
              pm2 show colonia-backend | grep -E "status|memory|cpu|restarts|uptime" || true
              
              # Mostrar uso de memoria actual
              echo "üìä Memoria actual:"
              pm2 prettylist | grep -A 5 "colonia-backend" | grep "memory" || echo "   Memoria: disponible"
            else
              echo "‚ùå ERROR: La app no est√° online despu√©s de 5s"
              echo "üìã √öltimos logs:"
              pm2 logs colonia-backend --lines 20 --nostream
              exit 1
            fi
            
            # ============================================
            # GUARDAR CONFIGURACI√ìN
            # ============================================
            echo "üíæ Guardando configuraci√≥n para reinicios..."
            pm2 save
            
            # Verificar que se guard√≥
            if [ $? -eq 0 ]; then
              echo "‚úÖ Configuraci√≥n guardada correctamente"
            else
              echo "‚ùå ERROR: No se pudo guardar la configuraci√≥n"
              exit 1
            fi
            
            # ============================================
            # VERIFICACI√ìN FINAL
            # ============================================
            echo "========================================="
            echo "üìä ESTADO FINAL:"
            echo "========================================="
            pm2 status
            echo "========================================="
            echo "‚úÖ DEPLOY COMPLETADO EXITOSAMENTE!"
            echo "========================================="