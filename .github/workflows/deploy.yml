name: Deploy colonia app

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: parajedorteoarango.com
          username: admin
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # ============================================
            # CONFIGURACI√ìN INICIAL
            # ============================================
            set -e  # Detener el script si hay alg√∫n error
            
            # CARGAR NVM
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            nvm use 20
            
            # VERIFICACI√ìN
            echo "========================================="
            echo "‚úÖ Usando Node: $(node -v)"
            echo "‚úÖ Usando NPM: $(npm -v)"
            echo "‚úÖ Usando PM2: $(pm2 -v)"
            echo "========================================="
            
            # ============================================
            # ACTUALIZAR C√ìDIGO
            # ============================================
            echo "üì¶ Actualizando repositorio..."
            cd /var/www/colonia-app
            git fetch --all
            git reset --hard origin/main
            git pull origin main
            
            # ============================================
            # FRONTEND - CORREGIDO
            # ============================================
            echo "üîß Construyendo frontend..."
            cd frontend
            
            # Verificar contenido del package.json
            echo "üìã Verificando dependencias..."
            cat package.json | grep -A 10 "\"dependencies\""
            cat package.json | grep -A 10 "\"devDependencies\""
            
            # Limpiar node_modules (opcional, si hay problemas)
            # rm -rf node_modules package-lock.json
            
            # Instalar TODAS las dependencias (necesario para build)
            echo "üì¶ Instalando dependencias completas..."
            npm ci  # Sin filtros, instala todo lo que est√° en package-lock.json
            
            # Verificar que vite est√° instalado
            echo "üîç Verificando instalaci√≥n de vite..."
            ls -la node_modules/.bin/vite || echo "vite no encontrado en .bin"
            npm list vite --depth=0
            
            echo "üî® Ejecutando build..."
            npm run build
            
            # Verificar que el build se complet√≥
            if [ -d "dist" ]; then
              echo "‚úÖ Build completado! Carpeta dist creada"
              ls -la dist/
            else
              echo "‚ùå ERROR: No se cre√≥ la carpeta dist"
              exit 1
            fi
            
            # ============================================
            # BACKEND
            # ============================================
            echo "üîß Configurando backend..."
            cd ../backend
            
            # Instalar dependencias de producci√≥n
            echo "üì¶ Instalando dependencias del backend..."
            npm ci --only=production
            
            # VERIFICAR QUE EL ARCHIVO DE CONFIGURACI√ìN EXISTE
            if [ ! -f "ecosystem.config.cjs" ]; then
              echo "‚ùå ERROR: ecosystem.config.cjs no encontrado!"
              exit 1
            fi
            
            # MOSTRAR CONFIGURACI√ìN ACTUAL
            echo "üìã Configuraci√≥n de PM2:"
            cat ecosystem.config.cjs
            
            # DETENER APLICACI√ìN ACTUAL (si existe)
            echo "üõë Deteniendo instancia anterior..."
            pm2 delete colonia-backend 2>/dev/null || true
            
            # INICIAR CON NUEVA CONFIGURACI√ìN
            echo "üöÄ Iniciando backend con ecosystem..."
            pm2 start ecosystem.config.cjs
            
            # ESPERAR 5 SEGUNDOS PARA VERIFICAR QUE NO FALLA
            echo "‚è≥ Verificando que la app se mantenga viva (5s)..."
            sleep 5
            
            # VERIFICAR ESTADO
            if pm2 status | grep -q "colonia-backend.*online"; then
              echo "‚úÖ Backend iniciado correctamente"
              pm2 show colonia-backend | grep "memory"
            else
              echo "‚ùå ERROR: La app no est√° online"
              pm2 logs colonia-backend --lines 20 --nostream
              exit 1
            fi
            
            # ============================================
            # GUARDAR CONFIGURACI√ìN
            # ============================================
            echo "üíæ Guardando configuraci√≥n para reinicios..."
            pm2 save
            
            # ============================================
            # VERIFICACI√ìN FINAL
            # ============================================
            echo "========================================="
            echo "üìä ESTADO FINAL:"
            echo "========================================="
            pm2 status
            echo "========================================="
            echo "‚úÖ DEPLOY COMPLETADO EXITOSAMENTE!"
            echo "========================================="