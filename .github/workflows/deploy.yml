name: Deploy colonia app

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: parajedorteoarango.com
          username: admin
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # ============================================
            # CONFIGURACI√ìN INICIAL
            # ============================================
            set -e  # Detener el script si hay alg√∫n error
            
            # CARGAR NVM
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            nvm use 20
            
            # VERIFICACI√ìN
            echo "========================================="
            echo "‚úÖ Usando Node: $(node -v)"
            echo "‚úÖ Usando NPM: $(npm -v)"
            echo "‚úÖ Usando PM2: $(pm2 -v)"
            echo "========================================="
            
            # ============================================
            # ACTUALIZAR C√ìDIGO
            # ============================================
            echo "üì¶ Actualizando repositorio..."
            cd /var/www/colonia-app
            git fetch --all
            git reset --hard origin/main
            git pull origin main
            
            # ============================================
            # FRONTEND
            # ============================================
            echo "üîß Construyendo frontend..."
            cd frontend
            npm ci --only=production  # M√°s r√°pido y determinista que npm install
            npm run build
            
            # ============================================
            # BACKEND - M√ÅXIMA SEGURIDAD
            # ============================================
            echo "üîß Configurando backend..."
            cd ../backend
            
            # Instalar dependencias (producci√≥n)
            npm ci --only=production
            
            # VERIFICAR QUE EL ARCHIVO DE CONFIGURACI√ìN EXISTE
            if [ ! -f "ecosystem.config.cjs" ]; then
              echo "‚ùå ERROR: ecosystem.config.cjs no encontrado!"
              exit 1
            fi
            
            # MOSTRAR CONFIGURACI√ìN ACTUAL
            echo "üìã Configuraci√≥n de PM2:"
            cat ecosystem.config.cjs
            
            # DETENER APLICACI√ìN ACTUAL (si existe)
            echo "üõë Deteniendo instancia anterior..."
            pm2 delete colonia-backend 2>/dev/null || true
            
            # LIMPIAR CACHE DE PM2 (opcional pero recomendado)
            pm2 flush
            
            # INICIAR CON NUEVA CONFIGURACI√ìN
            echo "üöÄ Iniciando backend con ecosystem..."
            pm2 start ecosystem.config.cjs
            
            # ESPERAR 5 SEGUNDOS PARA VERIFICAR QUE NO FALLA
            echo "‚è≥ Verificando que la app se mantenga viva (5s)..."
            sleep 5
            
            # VERIFICAR ESTADO
            if pm2 status | grep -q "colonia-backend.*online"; then
              echo "‚úÖ Backend iniciado correctamente"
              
              # MOSTRAR ESTADO
              pm2 status
              
              # MOSTRAR MEMORIA
              echo "üìä Consumo de memoria:"
              pm2 show colonia-backend | grep "memory"
            else
              echo "‚ùå ERROR: La app no est√° online despu√©s de 5s"
              echo "üìã √öltimos logs:"
              pm2 logs colonia-backend --lines 20 --nostream
              exit 1
            fi
            
            # ============================================
            # GUARDAR CONFIGURACI√ìN
            # ============================================
            echo "üíæ Guardando configuraci√≥n para reinicios..."
            pm2 save
            
            # VERIFICAR QUE EL DUMP SE CRE√ì
            if [ -f ~/.pm2/dump.pm2 ]; then
              echo "‚úÖ Configuraci√≥n guardada correctamente"
            else
              echo "‚ùå ERROR: No se pudo guardar la configuraci√≥n"
              exit 1
            fi
            
            # ============================================
            # VERIFICAR SERVICIO DE STARTUP
            # ============================================
            echo "üîç Verificando servicio de startup..."
            if systemctl is-enabled pm2-admin >/dev/null 2>&1; then
              echo "‚úÖ Servicio pm2-admin est√° habilitado"
            else
              echo "‚ö†Ô∏è  Servicio pm2-admin no est√° habilitado, configurando..."
              pm2 startup
            fi
            
            # ============================================
            # VERIFICACI√ìN FINAL
            # ============================================
            echo "========================================="
            echo "üìä ESTADO FINAL:"
            echo "========================================="
            pm2 status
            echo "========================================="
            echo "‚úÖ DEPLOY COMPLETADO EXITOSAMENTE!"
            echo "========================================="